# **Архитектурный манифест**

**Назначение документа:** \> Настоящий манифест определяет *как* мы разрабатываем, проектируем и тестируем прошивку. Он описывает архитектурные принципы, стандарты, процессы и ценности, которые обеспечивают создание устойчивого, расширяемого и сопровождаемого продукта. Документ **не описывает** бизнес-логику или конкретную реализацию.

## **1\. Философия и Принципы**

* **Надёжность и предсказуемость:** Надёжность важнее скорости. Код должен быть предсказуемым и безопасным.  
* **Модульность и расширяемость:** Архитектура разделена на независимые модули с чёткими интерфейсами.  
* **Простота и Читаемость:** Простота важнее избыточной оптимизации. Все участники пишут в едином стиле.  
* **Повторное использование:** Всё, что может быть библиотекой — должно быть библиотекой.  
* **Прозрачность и Документирование:** Все технические решения и изменения документируются.  
* **Автоматизация:** Все рутинные процессы (сборка, тестирование, поставка) должны быть автоматизированы.  
* **Качество и Аккуратность:** Каждая часть прошивки, библиотеки и документации проходит контроль качества.

## **2\. Архитектурный Стиль**

* **HAL (Hardware Abstraction Layer):**  
  * Строгое разделение уровней взаимодействия с оборудованием (HAL) и уровней бизнес-логики (App).  
  * Логика взаимодействия с физической периферией инкапсулируется в абстрактных драйверах.  
  * Бизнес-логика работает на уровне независимых от железа модулей.  
  * Все обращения к аппаратным функциям выполняются исключительно через интерфейсы HAL (I-префикс).  
* **Модульная и Событийно-ориентированная архитектура:**  
  * Функциональные блоки разделены.  
  * Взаимодействие между модулями (особенно между HAL и App) происходит асинхронно через события и очереди.  
  * Основа многозадачности — FreeRTOS.  
* **Принцип "Host-First Development":**
  * **Фаза 1 (Host):** 100% разработка и отладка всей бизнес-логики (`app/`) на ПК (`env:native`) с использованием mock-реализаций HAL.  
  * **Фаза 2 (Device):** Реализация "настоящих" HAL-драйверов для целевого МК.  
  * Бизнес-логика (`app/`) не должна изменяться при переходе между Фазами 1 и 2\.

## **3\. Среда и Процессы Разработки**

* **Инструменты:**  
  * IDE: VS Code \+ PlatformIO.  
  * Компилятор: GCC для ESP32.  
  * Система контроля версий: Git.  
* **Использование LLM и Агентов:**  
  * LLM (GitHub Copilot и др.) применяются как интеллектуальные ассистенты на всех этапах: генерация шаблонов, написание кода, анализ, тестирование, документирование.  
* **Процесс разработки:**  
  * Git Flow / trunk-based development.  
  * Обязательное ревью изменений через Pull Request.  
* **Управление зависимостями:**   
  * Все внешние библиотеки фиксируются в `platformio.ini` (`lib_deps`) с указанием версий.  
  * Добавление/обновление библиотек требует согласования и полного цикла тестирования.  
* **Версионирование:**
  * Прошивка версионируется по SemVer (MAJOR.MINOR.PATCH).

## **4\. Стандарты**

* **Стандарты кодирования:**  
  * Стиль кода: Google C++ Style Guide.  
  * Форматирование: clang-format.  
  * Статический анализ: `cppcheck`, `clang-tidy`.  
  * Именование:  
    * Файлы: `lower_snake_case.cpp/.h`  
    * Классы: `CamelCase`  
    * Функции: `lowerCamelCase()`  
    * Константы: `UPPER_SNAKE_CASE`  
* **Структура репозитория:**  
  * `src/app/`: Бизнес-логика (не зависит от железа).  
  * `src/hal/`: Реализация HAL для целевой платформы.  
  * `include/hal_interfaces/`: Абстрактные интерфейсы (I-префикс).  
  * `test/`: Тесты.  
  * `test/mocks/`: Mock-реализации HAL для `env:native`.  
* **Обработка ошибок и устойчивость:**  
  * Каждый модуль обрабатывает ошибки локально и уведомляет Core через события.  
  * Задачи FreeRTOS должны быть защищены от блокировок (watchdog).

## **5\. Подход к Тестированию и CI/CD**

* **Философия тестирования:**  
  * Строгий "Gated" пайплайн: переход к тестированию на "железе" (Target) невозможен, пока не пройдены все тесты на хосте (Host).  
* **Уровни тестирования:**   
  1. **Unit-тесты (Host / `env:native_tests`):** Тестирование чистых функций.  
  2. **Интеграционные тесты (Host / `env:native_tests`):** Тестирование полной цепочки бизнес-логики (`app/`) с использованием **моков HAL** (`test/mocks/`).  
  3. **Unit-тесты HAL (Target / `env:test_hal_...)`:** Изолированное тестирование **реальных HAL-драйверов** (`src/hal/`) на "железе".  
  4. **End-to-End тесты (Target / `env:e2e_tests`):** Полные HIL-тесты (Hardware-in-the-Loop).  
* **CI/CD Пайплайн:**   
  * **Этап 1 (Gate):** Статический анализ и Host-сборка.  
  * **Этап 2 (Gate):** Host-тестирование (Unit \+ Интеграция). *Блокирующий этап.*  
  * **Этап 3:** Target-сборка (для всех env:target).  
  * **Этап 4:** Target-тестирование (HAL-Unit \+ E2E на HIL).  
  * **Этап 5:** Поставка (сборка артефактов .bin, создание релиза).

## **6\. Документация**

* **Виды документации:** Разработческая, Пользовательская, QA.  
* **Форматы:** Markdown / Doxygen / Sphinx.  
* **Процесс:** Документация обновляется при каждом значительном изменении архитектуры или API.