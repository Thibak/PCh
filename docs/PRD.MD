# **Спецификация продукта (PRD): Эмулятор волынки**

**Назначение документа:** \> Этот документ описывает *что* представляет собой продукт: его назначение, целевую аудиторию, пользовательские сценарии, а также функциональные и нефункциональные требования. Он является основным источником правды для бизнес-логики и пользовательского опыта.

## **1\. Обзор продукта**

* **Назначение устройства:**
  * Эмулятор волынки для использования с музыкальными приложениями на смартфоне.  
  * Позволяет передавать MIDI-сигналы, редактировать аппликатуры и обеспечивать динамическую игровую выразительность.  
* **Основные пользователи:**  
  * Конечные потребители устройства — музыканты, использующие его как интерактивный MIDI-контроллер.  
* **Стадия проекта:**  
  * Прототип / MVP.

## **2\. Ключевые пользовательские сценарии (Use Cases)**

1. **Основной сценарий (BLE MIDI):** Пользователь включает устройство. Оно автоматически подключается по **BLE** к смартфону или ПК. При игре (закрытии сенсоров-отверстий) устройство генерирует MIDI-сигналы и передает их **строго по BLE**.  
2. **Редактирование аппликатуры (USB Flash Drive):** Пользователь подключает устройство по **USB** к компьютеру. Устройство распознается как **внешний Flash-накопитель**. Пользователь редактирует файл конфигурации аппликатуры (например, `fingering.cfg`). При следующей загрузке устройство использует новую аппликатуру.  
3. **Зарядка и питание:** USB-порт используется для зарядки аккумулятора и питания устройства.  
4. **Отладка и логирование:** При подключении по USB в определенном режиме устройство предоставляет COM-порт для вывода отладочных логов.

## **3\. Функциональные требования**

* **Цели прошивки:**  
  * Обеспечить корректное взаимодействие с пользователем через сенсоры.  
  * Поддерживать стабильное соединение по BLE и USB.  
  * Реализовать бизнес-логику обработки сигналов сенсоров и генерации MIDI-команд.  
* **Обработка сенсоров:**  
  * Устройство должно выполнять автоматическую калибровку сенсоров при включении.  
  * На устройстве реализован отдельный сенсор включения звука. На этапе MVP сенсор обрабатывается как состояние ВКЛ./ВЫКЛ. \- при котором состояние ВЫКЛ. отключает звук (передается MIDI-сигнал MUTE/ не передается никакой сигнал), а в состоянии ВКЛ. передается сигнал кодируемый через аппликатурный файл с сочетания остальных сенсоров. Реализация на всех уровнях должна позволять на дальнейших этапах регулировать этим каналом громкость звука.  
  * Устройство должно поддерживать динамическое управление выразительностью (вибрато, полузакрытое отверстие) через анализ движения пальца (жесты считываются с каждого сенсора как устойчивое синусоидальное изменение сигнала \~2-6Hz, которые следует отличать от шума сенсора по амплитуде изменения). На этапе MVP необходимо предусмотреть 2 жеста:  
    * вибрато \- не меняет “базовой ноты”, передает MIDI-сообщение (Pitch Bend);  
    * полузакрытие \- передает явный сигнал смены ноты, возможность полузакрытия должна быть явно указана файле аппликатуры, и должна быть явно указана нота, в случае, если для данного сенсора не указано значение полузакрытия, сигнал следует игнорировать  
  * Устройство должно преобразовывать комбинации нажатых сенсоров в MIDI-ноты согласно файлу аппликатуры.  
  * Устройство должно преобразовывать жесты (вибрато) в MIDI-сообщения (Pitch Bend).  
* **Конфигурация:**   
  * Файл аппликатуры должен определять взаимно-однозначное соответствие между комбинациями сигналов сенсоров и MIDI-командами.  
  * Этот файл должен быть доступен для редактирования при подключении по USB (см. Сценарий 2).  
  * Устройство должно позволять настраивать базовую частоту (concert pitch, напр. `A4=440Hz`) через `settings.cfg` для совместимости с разными строями (напр., `415Hz`).
* **Обновление прошивки:**  
  * Должна быть предусмотрена возможность обновления прошивки через USB.  
* **Диагностика и Телеметрия:**  
  * Устройство должно предоставлять встроенные средства самодиагностики (проверка сенсоров, соединений).  
  * Устройство должно собирать телеметрию (статистика использования, режимы энергопотребления).  
  * Логи и телеметрия должны быть доступны для выгрузки через USB.

## **4\. Нефункциональные требования (NFR)**

* **Производительность:**  
  * Минимальная задержка передачи MIDI-сигналов для точной синхронизации с аудиосигналом.  
* **Надежность:**  
  * Надёжность работы сенсоров и связи.  
  * Предсказуемое поведение при сбоях и некорректных входных данных.  
  * Корректное восстановление BLE-соединения при потере связи.  
* **Энергоэффективность:**  
  * **Автоматическое полное выключение** через 10 минут бездействия. Включение устройства осуществляется физической кнопкой питания.  
  * Поддержка контроля напряжения батареи и сигнализации низкого заряда.  
* **Безопасность:**  
  * Защита данных от некорректных сигналов.  
  * (Требования к шифрованию и подписи прошивки исключены из MVP).  
* **Пользовательский опыт (UX):**  
  * Поддержка различных музыкальных приложений без ограничений формата MIDI.  
  * На устройстве нет других интерфейсов управления, кроме сенсоров (для игрового режима).  
  * На устройстве должен быть светодиодный индикатор состояния устройства  
  * Светодиодный индикатор должен отображать сигналами  
    * частое мигание \- отсутствие BLE подключения  
    * светодиод горит \- BLE подключение есть  
    * каждая смена отправляемого MIDI-кода сопровождается морганием (blink)

## **5\. Требования к аппаратной платформе (Ограничения)**

* **Микроконтроллер:** ESP32-S3 (или совместимый).  
* **Память:** Flash 8 МБ (минимум), RAM 512 КБ (минимум).  
* **Сенсорная подсистема:** Аналоговые входы / I2C, 8–12 сенсоров.  
* **Коммуникационные интерфейсы:**  
  1. **BLE:** (Строго для MIDI).  
  2. **USB:** (Строго для питания, зарядки, редактирования аппликатуры (Mass Storage) и отладки (Serial)), используется встроенный USB микроконтроллера (USB 2.0 OTG)