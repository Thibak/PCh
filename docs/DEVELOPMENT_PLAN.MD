# **План разработки (Development Plan)**

**Назначение документа:** \> Этот документ описывает последовательность спринтов для реализации проекта. План основан на "design-first" подходе: сначала полная проработка документации (Эпик 0), затем реализация.

### **Эпик 0: Проектирование и Документация (Design & Docs) (\<— в работе)**

*Цель: Полностью спроектировать и задокументировать весь проект, прежде чем будет написана первая строка кода.*

1. **(+) Спринт 0.1 (Док):** Финализация высокоуровневых документов: PRD.MD, ARCH\_MANIFEST.MD, ARCH\_CONTRACT.MD, HW\_SPEC.md.  
2. **(+) Спринт 0.2 (Док):** Создание **docs/CONFIG\_SCHEMA.md**. (Ключевой документ: описывает точную структуру settings.cfg и fingering.cfg).  
3. **(+) Спринт 0.3 (Док):** Создание docs/modules/core\_config\_manager.md.  
4. **(+) Спринт 0.4 (Док):** Создание docs/modules/core\_event\_dispatcher.md.  
5. **(+) Спринт 0.5 (Док):** Создание docs/modules/diagnostics\_logging.md.  
6. **(+) Спринт 0.6 (Док):** Создание docs/modules/core\_scheduler.md.  
7. **(+) Спринт 0.7 (Док):** Создание docs/modules/hal\_storage.md.  
8. **(+) Спринт 0.8 (Док):** Создание docs/modules/hal\_usb.md.  
9. **(+) Спринт 0.9 (Док):** Создание docs/modules/hal\_led.md.  
10. **(+) Спринт 0.10 (Док):** Создание docs/modules/hal\_ble.md.  
11. **(+) Спринт 0.11 (Док):** Создание docs/modules/hal\_sensors.md.  
12. **(+) Спринт 0.12 (Док):** Создание docs/modules/hal\_power.md.  
13. **(-\>) Спринт 0.13 (Док):** Создание docs/modules/app\_fingering.md.  
14. **Спринт 0.14 (Док):** Создание docs/modules/app\_logic.md.  
15. **Спринт 0.15 (Док):** Создание docs/modules/app\_midi.md.

**(Результат Эпика 0: Все модули описаны, все контракты определены. Проект "понятен".)**

### **Эпик 1: Настройка Проекта и Mock-Инфраструктуры (Setup & Mocks)**

*Цель: Подготовить репозиторий, CI/CD, а также **полный набор Mock-классов** для тестирования по принципу "Host-First".*

16. **Спринт 1.1 (Код):** Инициализация Git, .gitignore, clang-format, cppcheck.  
17. **Спринт 1.2 (Код):** Создание platformio.ini (\[env:native\], \[env:esp32s3\_app\]).  
18. **Спринт 1.3 (Код):** Настройка CI/CD (Этап 1 Линтинг, Этап 2 Сборка env:native).  
19. **Спринт 1.4 (Код):** Создание структуры папок (src/app, src/hal, src/core, include/hal\_interfaces, test/mocks).  
20. **Спринт 1.5 (Код):** Создание всех абстрактных интерфейсов (i\_hal\_\*.h) в include/hal\_interfaces/.  
21. **Спринт 1.6 (Код / Mock):** Реализация MockHalStorage. (Должен уметь читать settings.cfg из файловой системы ПК для тестов).  
22. **Спринт 1.7 (Код / Mock):** Реализация MockHalUsb. (Должен выводить serialPrint() в stdout консоли).  
23. **Спринт 1.8 (Код / Mock):** Реализация MockHalLed. (Должен выводить setMode() в stdout консоли).  
24. **Спринт 1.9 (Код / Mock):** Реализация MockHalBle. (Должен записывать sendMidiMessage() в буфер для проверки тестами).  
25. **Спринт 1.10 (Код / Mock):** Реализация MockHalSensors. (Должен иметь API pushMockSensorValue(id, value), чтобы тесты могли им управлять).  
26. **Спринт 1.11 (Код / Mock):** Реализация MockHalPower и MockHalSystem. (Простые заглушки).

### **Эпик 2: Ядро и Бизнес-Логика (Core & App Logic \- Host-First)**

*Цель: Реализовать и протестировать 100% "мозга" устройства на ПК (env:native), используя Mock-классы из Эпика 1\.*

27. **Спринт 2.1 (Код):** Реализация core/config\_manager.  
28. **Спринт 2.2 (Тест):** Unit-тесты для core/config\_manager (Host) (используя MockHalStorage).  
29. **Спринт 2.3 (Код):** Реализация core/event\_dispatcher.  
30. **Спринт 2.4 (Тест):** Unit-тесты для core/event\_dispatcher (Host).  
31. **Спринт 2.5 (Код):** Реализация diagnostics\_logging.  
32. **Спринт 2.6 (Тест):** Unit-тесты для diagnostics\_logging (Host) (проверка вывода в MockHalUsb).  
33. **Спринт 2.7 (Код):** Реализация app\_fingering (Парсинг, поиск ноты).  
34. **Спринт 2.8 (Тест):** Интеграционный тест для app\_fingering (Host) (используя MockHalStorage).  
35. **Спринт 2.9 (Код):** Реализация app\_logic (Детекция Mute, Mask, HalfHole, Vibrato).  
36. **Спринт 2.10 (Тест):** Интеграционный тест для app\_logic (Host) (Подать MockSensorValue, проверить исходящие события).  
37. **Спринт 2.11 (Код):** Реализация app\_midi (Обработка всех событий, формирование MIDI).  
38. **Спринт 2.12 (Тест):** Интеграционный тест для app\_midi (Host) (Подать события, проверить вызовы MockHalBle и MockHalLed).

### **Эпик 3: Реализация HAL (Hardware Abstraction Layer)**

*Цель: Написать "железные" реализации HAL-интерфейсов для ESP32-S3 и протестировать их в изоляции.*

39. **Спринт 3.1 (Код):** Реализация hal\_storage (SPIFFS/LittleFS).  
40. **Спринт 3.2 (Тест):** HAL Unit-тест для hal\_storage (Target). (Тест: создать/прочитать файл).  
41. **Спринт 3.3 (Код):** Реализация hal\_usb (Композитное устройство Serial \+ Mass Storage).  
42. **Спринт 3.4 (Тест):** HAL Unit-тест для hal\_usb (Target). (Тест: подключить к ПК, увидеть Serial и 'флешку').  
43. **Спринт 3.5 (Код):** Реализация hal\_led (Neopixel/Dotstar).  
44. **Спринт 3.6 (Тест):** HAL Unit-тест для hal\_led (Target). (Тест: setMode(FAST\_BLINK)).  
45. **Спринт 3.7 (Код):** Реализация hal\_ble (BLE MIDI сервис).  
46. **Спринт 3.8 (Тест):** HAL Unit-тест для hal\_ble (Target). (Тест: подключиться к телефону).  
47. **Спринт 3.9 (Код):** Реализация hal\_sensors (Touch Pins, фильтрация).  
48. **Спринт 3.10 (Тест):** HAL Unit-тест для hal\_sensors (Target). (Тест: читать значения в Serial).  
49. **Спринт 3.11 (Код):** Реализация hal\_power (API: getBatteryLevel()).  
50. **Спринт 3.12 (Тест):** HAL Unit-тест для hal\_power (Target).

### **Эпик 4: Полная Интеграция (E2E)**

*Цель: Собрать APP (Эпик 2\) и HAL (Эпик 3\) вместе на "железе" и протестировать сквозные сценарии.*

51. **Спринт 4.1 (Код):** Реализация core/scheduler (Создание всех задач FreeRTOS).  
52. **Спринт 4.2 (Код):** Реализация main.cpp (Инициализация всех модулей, запуск scheduler).  
53. **Спринт 4.3 (Тест):** E2E Тест (Сценарий 1: MIDI). (Замкнуть Touch-пин \-\> Проверить NoteOn на телефоне).  
54. **Спринт 4.4 (Тест):** E2E Тест (Сценарий 1: Вибрато). (Имитировать вибрато \-\> Проверить PitchBend на телефоне).  
55. **Спринт 4.5 (Тест):** E2E Тест (Сценарий 2/3: USB). (Подключить к ПК \-\> Проверить Serial Log и Mass Storage).  
56. **Спринт 4.6 (Тест):** E2E Тест (Сценарий 4: LED). (Подключить BLE \-\> LED горит. Играть \-\> LED моргает).

### **Эпик 5: UX и Завершение MVP**

*Цель: Реализовать оставшиеся NFR и отполировать продукт.*

57. **Спринт 5.1 (Код):** Реализация hal\_power (Логика таймера авто-выключения и triggerPowerOff()).  
58. **Спринт 5.2 (Код):** Интеграция hal\_power в core/scheduler (Вызов triggerPowerOff() по событию).  
59. **Спринт 5.3 (Тест):** E2E Тест (Авто-выключение). (Оставить устройство на 10 мин \-\> Проверить выключение).  
60. **Спринт 5.4 (Код):** Реализация авто-калибровки в hal\_sensors.  
61. **Спринт 5.5 (Тест):** Тестирование авто-калибровки (Target).  
62. **Спринт 5.6 (Рефакторинг):** Тюнинг алгоритмов app\_logic (подбор порогов settings.cfg для вибрато).  
63. **Спринт 5.7 (Док):** Написание Руководства пользователя (User Manual).  
64. **Спринт 5.8 (MVP):** MVP Release 1.0.0.