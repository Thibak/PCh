# **План разработки (Development Plan)**

**Назначение документа:** \> Этот документ описывает последовательность спринтов для реализации проекта. План основан на "design-first" подходе: сначала полная проработка документации (Эпик 0), затем реализация.

### **(+)Эпик 0: Проектирование и Документация (Design & Docs)**

*Цель: Полностью спроектировать и задокументировать весь проект, прежде чем будет написана первая строка кода.*

1. **(+) Спринт 0.1 (Док):** Финализация высокоуровневых документов: `PRD.MD`, `ARCH_MANIFEST.MD`, `ARCH_CONTRACT.MD`, `HW_SPEC.md`.  
2. **(+) Спринт 0.2 (Док):** Создание `docs/CONFIG_SCHEMA.md`. (Ключевой документ: описывает точную структуру `settings.cfg` и `fingering.cfg`).  
3. **(+) Спринт 0.3 (Док):** Создание `docs/modules/core_config_manager.md`.  
4. **(+) Спринт 0.4 (Док):** Создание `docs/modules/core_event_dispatcher.md`.  
5. **(+) Спринт 0.5 (Док):** Создание `docs/modules/diagnostics_logging.md`.  
6. **(+) Спринт 0.6 (Док):** Создание `docs/modules/core_scheduler.md`.  
7. **(+) Спринт 0.7 (Док):** Создание `docs/modules/hal_storage.md`.  
8. **(+) Спринт 0.8 (Док):** Создание `docs/modules/hal_usb.md`.  
9. **(+) Спринт 0.9 (Док):** Создание `docs/modules/hal_led.md`.
10. **(+) Спринт 0.10 (Док):** Создание `docs/modules/hal_ble.md`.  
11. **(+) Спринт 0.11 (Док):** Создание `docs/modules/hal_sensors.md`.  
12. **(+) Спринт 0.12 (Док):** Создание `docs/modules/hal_power.md`.  
13. **(+) Спринт 0.13 (Док):** Создание `docs/modules/app_fingering.md`.  
14. **(+) Спринт 0.14 (Док):** Создание `docs/modules/app_logic.md`.  
15. **(+) Спринт 0.15 (Док):** Создание `docs/modules/app_midi.md`.
16. **(+) Спринт 0.16 (Док):** Создание `docs/modules/hal_system.md` (для `timestamp`).

**(Результат Эпика 0: Все модули описаны, все контракты определены. Проект "понятен".)**

### **(+) Эпик 1: Настройка Проекта и Mock-Инфраструктуры (Setup & Mocks)**

*Цель: Подготовить репозиторий, CI/CD, а также **полный набор Mock-классов** для тестирования по принципу "Host-First".*

* **(+) Спринт 1.1 (Код):** Инициализация `Git`, `.gitignore`, `clang-format`, `cppcheck`.  
* **(+) Спринт 1.2 (Код):** Создание `platformio.ini` (`[env:native]`, `[env:esp32s3_app]`).  
* **(+) Спринт 1.3 (Код):** Настройка CI/CD (Этап 1 Линтинг, Этап 2 Сборка `env:native`).  
* **(+) Спринт 1.4 (Код):** Создание структуры папок (`src/app`, `src/hal`, `src/core`, `include/hal_interfaces`, `test/mocks`).  
* **(+) Спринт 1.5 (Код):** Создание всех абстрактных интерфейсов (`i_hal_*.h`) в `include/hal_interfaces/`.  
* **(+) Спринт 1.6 (Код / Mock):** Реализация `MockHalStorage`. (Должен уметь читать `settings.cfg` из файловой системы ПК для тестов).  
* **(+) Спринт 1.7 (Код / Mock):** Реализация `MockHalUsb`. (Должен выводить `serialPrint()` в `stdout` консоли).  
* **(+) Спринт 1.8 (Код / Mock):** Реализация `MockHalLed`. (Должен выводить `setMode()` в `stdout` консоли).  
* **(+) Спринт 1.9 (Код / Mock):** Реализация `MockHalBle`. (Должен записывать `sendMidiMessage()` в буфер для проверки тестами).  
* **(+) Спринт 1.10 (Код / Mock):** Реализация `MockHalSensors`. (Должен иметь API `pushMockSensorValue(id, value)`, чтобы тесты могли им управлять).  
* **(+) Спринт 1.11 (Код / Mock):** Реализация `MockHalPower` и `MockHalSystem`. (Простые заглушки).

### **Эпик 2: Ядро и Бизнес-Логика (Core & App Logic \- Host-First) (\<— в работе)**

*Цель: Реализовать и протестировать 100% "мозга" устройства на ПК (`env:native`), используя Mock-классы из Эпика 1\.*

* **(+) Спринт 2.1 (Код: Каркас)**: Создание всех заголовочных файлов `.h` для `CORE` (`Scheduler.h`, `ConfigManager.h`, `EventDispatcher.h`, `Logger.h`) и `APP` (`AppFingering.h`, `AppLogic.h`, `AppMidi.h`).
* **(+) Спринт 2.2 (Код: Заглушки)**: Создание всех `.cpp` файлов (с пустыми методами) для `CORE` и `APP`, чтобы проект компилировался.
* **(+) Спринт 2.3 (Код+Unit)**: Модуль `core/config_manager`.
  * Реализация `src/core/ConfigManager.cpp`.
  * Unit-тест `test/test_config_manager/test_main.cpp`.
* **(+) Спринт 2.4 (Код+Unit)**: Модуль `core/event_dispatcher` (с использованием `MockEventHandler`).
  * Реализация `src/core/EventDispatcher.cpp` (Native Sync Mode).
  * Unit-тест `test/test_event_dispatcher/test_main.cpp`.
* **(+) Спринт 2.5 (Код+Unit)**: Модуль `diagnostics/logger`.
  * Реализация `src/core/Logger.cpp`.
  * Unit-тест `test/test_logger/test_main.cpp` (проверка форматирования и вывода в `MockHalUsb`).
* **(+) Спринт 2.6 (Код+Unit)**: Модуль `app/fingering`.
  * Реализация `src/app/AppFingering.cpp`.
  * Unit-тест `test/test_app_fingering/test_main.cpp` (Изолированная проверка таблицы аппликатур).
* **(+) Спринт 2.7 (Код+Unit)**: Модуль `app/logic` (Часть 1: Mute, Mask).
  * Реализация `src/app/AppLogic.cpp` (Базовая машина состояний).
  * Unit-тест `test/test_app_logic/test_main.cpp` (Изолированная проверка логики порогов).
* **(+) Спринт 2.8 (Код+Unit)**: Модуль `app/midi`.
  * Реализация `src/app/AppMidi.cpp`.
  * Unit-тест `test/test_app_midi/test_main.cpp` (Изолированная проверка генерации MIDI-команд).
* **(+) Спринт 2.9 (Код+Unit)**: Интеграция `core/scheduler`.
  * Реализация `src/core/Scheduler.cpp` (связывание всего).
  * Smoke-тест `test/test_scheduler/test_main.cpp` (уже существует, поддержка актуальности).
* **(-\>) Спринт 2.10 (Код+Unit)**: Доработка `app/logic` (Вибрато и Полузакрытие).
  * Доработка реализации.
  * Расширение Unit-теста.
* **Спринт 2.11 (Код+Unit)**: Доработка `app/midi` (Настройка строя `base_pitch_hz`).
  * Доработка реализации.
  * Расширение Unit-теста.
* **Спринт 2.12 (Integration Tests)**: Полная цепочка сигналов (Host).
  * Создание `test/integration/test_full_chain/test_main.cpp`.
  * Тест 1: `MockSensor` -\> `AppLogic` -\> `EventDispatcher` -\> `AppFingering` -\> `AppMidi` -\> `MockHalBle` (Проверка: нажатие сенсора вызывает NoteOn).
  * Тест 2: `MockSensor` (Mute) -\> ... -\> `MockHalBle` (AllNotesOff).
  * Тест 3: Изменение конфига -\> Перезагрузка логики (через моки).


<!-- * **(+) Спринт 2.3 (Тест)**: Создание `test/test_main.cpp` и интеграционный тест для `core/scheduler` (проверка `init` и `startTasks` на `env:native`).
* **(+) Спринт 2.4 (Код)**: Реализация `core/config_manager.cpp`.
* **(+) Спринт 2.5 (Тест)**: Unit-тесты для `core/config_manager` (Host) (используя `MockHalStorage`).
* **(+) Спринт 2.6 (Код)**: Реализация `core/event_dispatcher.cpp`.
* **(+) Спринт 2.7 (Тест)**: Unit-тесты для `core/event_dispatcher` (Host).
* **(-\>) Спринт 2.8 (Код)**: Реализация `diagnostics/logger.cpp`.
* **Спринт 2.9 (Тест)**: Unit-тесты для `diagnostics/logger` (Host) (проверка вывода в `MockHalUsb`).
* **Спринт 2.10 (Код)**: Реализация `app/fingering.cpp` (Парсинг, поиск ноты).
* **Спринт 2.11 (Тест)**: Интеграционный тест для `app/fingering` (Host) (используя `MockHalStorage`).
* **Спринт 2.12 (Код)**: Реализация `app/logic.cpp` (Детекция `Mute`, Mask, `HalfHole`).
* **Спринт 2.13 (Тест)**: Интеграционный тест для `app/logic` (Host) (Подать `MockSensorValue`, проверить исходящие события).
* **Спринт 2.14 (Код)**: Реализация `app/midi.cpp` (Обработка `NotePitch`, `Mute`).
* **Спринт 2.15 (Тест)**: Интеграционный тест для `app/midi` (Host) (Подать события, проверить вызовы `MockHalBle` и `MockHalLed`).
* **Спринт 2.16 (Код)**: Доработка `app/logic` (Реализация детекции Вибрато).
* **Спринт 2.17 (Тест)**: Интеграционный тест для `app/logic` (Вибрато).
* **Спринт 2.18 (Код)**: Доработка `app/midi` (Реализация `base_pitch_hz` RPN/MTS).
* **Спринт 2.19 (Тест)**: Интеграционный тест для `app/midi` (Проверка `base_pitch_hz`). -->

### **Эпик 3: Реализация HAL (Hardware Abstraction Layer)**

*Цель: Написать "железные" реализации HAL-интерфейсов для ESP32-S3 и протестировать их в изоляции.*

39. **Спринт 3.1 (Код):** Реализация hal\_storage (SPIFFS/LittleFS).  
40. **Спринт 3.2 (Тест):** HAL Unit-тест для hal\_storage (Target). (Тест: создать/прочитать файл).  
41. **Спринт 3.3 (Код):** Реализация hal\_usb (Композитное устройство Serial \+ Mass Storage).  
42. **Спринт 3.4 (Тест):** HAL Unit-тест для hal\_usb (Target). (Тест: подключить к ПК, увидеть Serial и 'флешку').  
43. **Спринт 3.5 (Код):** Реализация hal\_led (Neopixel/Dotstar).  
44. **Спринт 3.6 (Тест):** HAL Unit-тест для hal\_led (Target). (Тест: setMode(FAST\_BLINK)).  
45. **Спринт 3.7 (Код):** Реализация hal\_ble (BLE MIDI сервис).  
46. **Спринт 3.8 (Тест):** HAL Unit-тест для hal\_ble (Target). (Тест: подключиться к телефону).  
47. **Спринт 3.9 (Код):** Реализация hal\_sensors (Touch Pins, фильтрация).  
48. **Спринт 3.10 (Тест):** HAL Unit-тест для hal\_sensors (Target). (Тест: читать значения в Serial).  
49. **Спринт 3.11 (Код):** Реализация hal\_power (API: getBatteryLevel()).  
50. **Спринт 3.12 (Тест):** HAL Unit-тест для hal\_power (Target).

### **Эпик 4: Полная Интеграция (E2E)**

*Цель: Собрать APP (Эпик 2\) и HAL (Эпик 3\) вместе на "железе" и протестировать сквозные сценарии.*

51. **Спринт 4.1 (Код):** Реализация core/scheduler (Создание всех задач FreeRTOS).  
52. **Спринт 4.2 (Код):** Реализация main.cpp (Инициализация всех модулей, запуск scheduler).  
53. **Спринт 4.3 (Тест):** E2E Тест (Сценарий 1: MIDI). (Замкнуть Touch-пин \-\> Проверить NoteOn на телефоне).  
54. **Спринт 4.4 (Тест):** E2E Тест (Сценарий 1: Вибрато). (Имитировать вибрато \-\> Проверить PitchBend на телефоне).  
55. **Спринт 4.5 (Тест):** E2E Тест (Сценарий 2/3: USB). (Подключить к ПК \-\> Проверить Serial Log и Mass Storage).  
56. **Спринт 4.6 (Тест):** E2E Тест (Сценарий 4: LED). (Подключить BLE \-\> LED горит. Играть \-\> LED моргает).

### **Эпик 5: UX и Завершение MVP**

*Цель: Реализовать оставшиеся NFR и отполировать продукт.*

57. **Спринт 5.1 (Код):** Реализация hal\_power (Логика таймера авто-выключения и triggerPowerOff()).  
58. **Спринт 5.2 (Код):** Интеграция hal\_power в core/scheduler (Вызов triggerPowerOff() по событию).  
59. **Спринт 5.3 (Тест):** E2E Тест (Авто-выключение). (Оставить устройство на 10 мин \-\> Проверить выключение).  
60. **Спринт 5.4 (Код):** Реализация авто-калибровки в hal\_sensors.  
61. **Спринт 5.5 (Тест):** Тестирование авто-калибровки (Target).  
62. **Спринт 5.6 (Рефакторинг):** Тюнинг алгоритмов app\_logic (подбор порогов settings.cfg для вибрато).  
63. **Спринт 5.7 (Док):** Написание Руководства пользователя (User Manual).  
64. **Спринт 5.8 (MVP):** MVP Release 1.0.0.