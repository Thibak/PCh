# **Схема конфигурационных файлов**

**Назначение документа:** \> Этот документ описывает точную структуру и синтаксис файлов settings.cfg и fingering.cfg. Он является "контрактом данных" для модулей core\_config\_manager и app/fingering.

## **1\. Файл settings.cfg**

Файл settings.cfg используется модулем core\_config\_manager для загрузки порогов, пинов и других настроек.

* **Формат:** INI-подобный (key \= value).  
* **Комментарии:** Начинаются с символа \#.  
* **Парсинг:** Пробелы вокруг \= игнорируются.

### **1.1. Секция \[system\]**

| Ключ | Тип | По умолчанию | Описание |
| :---- | :---- | :---- | :---- |
| log\_level | string | WARN | Уровень логирования. (Допустимые: DEBUG, INFO, WARN, ERROR). |
| auto\_off\_time\_min | int | 10 | Время бездействия в минутах до авто-выключения. |
| led\_pin | string | TBD | **(Новое)** Физический GPIO пин для встроенного LED (напр. GPIO48). |

### **1.2. Секция \[sensors\] (Обновлено)**

Эта секция определяет, какие *физические* пины ESP32 используются и каким *логическим* ID они назначаются.

| Ключ | Тип | По умолчанию | Описание |
| :---- | :---- | :---- | :---- |
| physical\_pins | string | T1,T2,T3,T4,T5,T6,T7,T8,T9 | **(Критично)** Задает карту пинов. Это упорядоченный список *физических* Touch-пинов ESP32 (T1-T14). Порядок в этом списке определяет *логический ID* (Индекс 0 \= ID 0, Индекс 1 \= ID 1, ...). |
| sample\_rate\_hz | int | 50 | Частота (Hz) генерации событий SensorValueChanged. |
| filter\_alpha | float | 0.1 | **(Новое)** Коэффициент EMA-сглаживания (0.0-1.0). 0.1 \= сильное сглаживание, 1.0 \= нет сглаживания. |
| mute\_threshold | int | 500 | Порог срабытывания для сенсора, назначенного mute\_sensor\_id. |
| hole\_closed\_threshold | int | 400 | Порог "полностью закрытого" отверстия. app/logic использует это для построения 8-битной маски. (См. Диаграмму 3-х позиционного сенсора). |

### **1.3. Секция \[app\_logic\]**

Эта секция определяет, как app/logic должен интерпретировать *логические ID*, определенные в \[sensors\].

| Ключ | Тип | По умолчанию | Описание |
| :---- | :---- | :---- | :---- |
| mute\_sensor\_id | int | 8 | **(Критично)** *Логический ID* (индекс из physical\_pins), который отвечает за Mute. app/logic будет перехватывать этот ID. |
| hole\_sensor\_ids | string | 0,1,2,3,4,5,6,7 | **(Критично)** Упорядоченный список *логических ID*, которые формируют 8-битную игровую маску для fingering.cfg. |

### **1.4. Секция \[gestures\] (Жесты)**

| Ключ | Тип | По умолчанию | Описание |
| :---- | :---- | :---- | :---- |
| vibrato\_freq\_min\_hz | float | 2.0 | Минимальная частота (Hz) для детекции вибрато. |
| vibrato\_freq\_max\_hz | float | 6.0 | Максимальная частота (Hz) для детекции вибрато. |
| vibrato\_amplitude\_min | int | 50 | Минимальная амплитуда для детекции вибрато (отсечка шума). |
| half\_hole\_threshold | int | 300 | Порог срабатывания "полузакрытия". |
| half\_hole\_threshold | int | 300 | Порог срабатывания "полузакрытия". Должен быть ниже, чем hole_closed_threshold. (См. Диаграмму 3-х позиционного сенсора). |

### **1.5. Пример settings.cfg (Обновлено)**

Этот пример является полным, готовым к использованию файлом конфигурации по умолчанию.

\# \--- Системные настройки \---  
\[system\]  
log\_level \= INFO  
auto\_off\_time\_min \= 10  
led\_pin \= TBD\_GPIO\_LED\_PIN \# Указать точный пин (напр. GPIO48)

\# \--- Настройки сенсоров (Карта пинов) \---  
\# Определяет 9 логических ID (0-8) и привязывает их к 9 физическим пинам ESP32  
\[sensors\]  
physical\_pins \= T1, T2, T3, T4, T5, T6, T7, T8, T9  
sample\_rate\_hz \= 50  
filter\_alpha \= 0.1 \# Коэффициент сглаживания (0.1 \= сильно, 1.0 \= нет)  
mute\_threshold \= 500
hole_closed_threshold \= 400 \# Порог для "закрыто" (для маски)

\# \--- Настройки "Мозга" (app/logic) \---  
\# Указывает "мозгу", как использовать логические ID из \[sensors\]  
\[app\_logic\]  
\# Логический ID 8 (девятый в списке physical\_pins) используется для Mute  
mute\_sensor\_id \= 8  
\# Логические ID 0-7 (первые восемь) формируют 8-битную маску отверстий  
hole\_sensor\_ids \= 0, 1, 2, 3, 4, 5, 6, 7

\# \--- Настройки жестов (app/logic) \---  
\[gestures\]  
vibrato\_freq\_min\_hz \= 2.0  
vibrato\_freq\_max\_hz \= 6.0  
vibrato\_amplitude\_min \= 50  
half\_hole\_threshold \= 300
half_hole_threshold \= 300 \# Порог для "полузакрыто" \(должен быть \< hole_closed_threshold\)

## **2\. Файл fingering.cfg**

Файл fingering.cfg используется модулем app/fingering для трансляции 8-битной *маски отверстий* в MIDI-ноты.

* **Формат:** Текстовый, одна строка — одно правило.  
* **Комментарии:** Строки, начинающиеся с \#, игнорируются.  
* **Структура строки:** MASK NOTE \[HALF\_HOLE\_SENSOR\_ID HALF\_HOLE\_NOTE\]

### **2.1. Описание полей**

1. **MASK (Маска)**  
   * **Тип:** 8-битное беззнаковое целое.  
   * **Формат:** **Бинарный (0b...)** или шестнадцатеричный (0x...). Бинарный формат является предпочтительным для ясности.  
   * **Описание:** Битовая маска 8-ми сенсоров **отверстий**.  
   * **Порядок бит:** Порядок бит в маске 0b(S7 S6 S5 S4 S3 S2 S1 S0) соответствует порядку сенсоров в hole\_sensor\_ids из settings.cfg.  
     * S0 (самый правый бит) \= ID из hole\_sensor\_ids\[0\]  
     * S1 \= ID из hole\_sensor\_ids\[1\]  
     * ...  
     * S7 (самый левый бит) \= ID из hole\_sensor\_ids\[7\]  
   * **Примечание:** Сенсор Mute (mute\_sensor\_id) здесь *не* учитывается.  
2. **NOTE (Нота)**  
   * **Тип:** 8-битное целое (0-127).  
   * **Описание:** MIDI-нота, которая будет отправлена, если активна эта MASK.  
   * **Специальное значение:** 0 (или NOTE\_OFF) означает "тишину" (Note Off).  
3. **\[HALF\_HOLE\_SENSOR\_ID\] (Опционально: ID сенсора полузакрытия)**  
   * **Тип:** Целое (0-7).  
   * **Описание:** **Логический ID** сенсора отверстия (из hole\_sensor\_ids), который *может* быть полузакрыт при *этой* маске.  
4. **\[HALF\_HOLE\_NOTE\] (Опционально: Нота полузакрытия)**  
   * **Тип:** 8-битное целое (0-127).  
   * **Описание:** MIDI-нота, которая будет отправлена *вместо* NOTE, если app/logic определит полузакрытие на HALF\_HOLE\_SENSOR\_ID.

### **2.2. Пример fingering.cfg (Обновлено)**

\# Пример аппликатуры для 8 сенсоров отверстий (ID 0-7)  
\# (Предполагается, что hole\_sensor\_ids \= 0,1,2,3,4,5,6,7)  
\#  
\# Сенсор 0: Задний (S0)  
\# Сенсор 1: Верхний (S1)  
\# ...  
\# Сенсор 7: Нижний (S7)  
\#  
\# MASK: 0b(S7 S6 S5 S4 S3 S2 S1 S0)  
\# 1 \= закрыт, 0 \= открыт

\# Все 8 сенсоров отверстий закрыты (Нота До / C4)  
0b11111111 60

\# Все кроме S0 (ID 0\) (Нота Ре / D4)  
0b11111110 62

\# Все кроме S0 (ID 0\) и S1 (ID 1\) (Нота Ми / E4)  
0b11111100 64

\# ... и так далее ...

\# Пример полузакрытия (для ноты D4)  
\# Если активна маска 0b11111110 (нота D4) И  
\# сенсор с логическим ID 1 переходит в "полузакрыт",  
\# то отправить ноту 63 (D\#4) вместо 62 (D4).  
0b11111110 62 1 63

\# Все открыты  
0b00000000 0 \# NOTE\_OFF (Тишина)  
