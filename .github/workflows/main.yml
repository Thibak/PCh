# -----------------------------------------------------------------
# PCh CI/CD Pipeline (GitHub Actions)
# -----------------------------------------------------------------
# 
# Назначение: Автоматически проверяет качество кода
# при каждом 'push' или 'pull_request'.
#
# Соответствует: DEVELOPMENT_PLAN.MD - Спринт 1.3
#               ARCH_MANIFEST.MD - Раздел 5
#
# -----------------------------------------------------------------

# 1. Имя рабочего процесса
name: PCh CI/CD Pipeline

# 2. Триггеры (Когда запускать)
# Запускаем на любой push или pull_request в ветку 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 3. Задачи (Jobs)
jobs:
  # -------------------------------------------------
  # ЗАДАЧА 1: Линтинг / Статический Анализ
  # (Соответствует "Этапу 1" нашего пайплайна)
  # -------------------------------------------------
  lint-job:
    name: 1. Linting (cppcheck)
    runs-on: ubuntu-latest # Используем Linux VM от GitHub

    steps:
      # 1. Скачиваем наш код
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Устанавливаем Python (необходим для PlatformIO)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. Устанавливаем PlatformIO
      - name: Install PlatformIO
        run: pip install -U platformio

      # 4. Запускаем Линтер (cppcheck) на окружении 'native'
      - name: Run Static Analysis (cppcheck)
        run: pio check --environment=native

  # -------------------------------------------------
  # ЗАДАЧА 2: Сборка "Host" окружения
  # (Соответствует "Этапу 2" нашего пайплайна)
  # -------------------------------------------------
  build-native-job:
    name: 2. Build (env:native)
    runs-on: ubuntu-latest

    # ЗАВИСИМОСТЬ: Эта задача запустится ТОЛЬКО если 'lint-job' прошла успешно
    needs: lint-job 

    steps:
      # 1. Скачиваем код
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Устанавливаем Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Устанавливаем PlatformIO
      - name: Install PlatformIO
        run: pip install -U platformio

      # 4. (КРИТИЧНО) Устанавливаем C++ компилятор (g++)
      # (Это Linux-эквивалент установки MinGW-w64 на Windows)
      - name: Install C++ compiler (g++)
        run: sudo apt-get update && sudo apt-get install -y g++

      # 5. Запускаем сборку 'native' окружения
      - name: Build native environment
        run: pio run --environment=native